<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Chat Room</title>
</head>
<body>

<div class="room-enter">
    <label>
        <input id="room-id" placeholder="room id">
    </label>
    <label>
        <input id="user-id" placeholder="user id">
    </label>
    <button onclick="onConnect()">connect</button>
</div>

<div class="room-main">
    <div id="msg"></div>
    <label>
        <input id="msg-input" placeholder="input a message to send">
    </label>
    <button onclick="onSend()">send</button>
</div>
<script>

    const host = window.location.host
    const connect = (roomID, userID) => {
        let ws = new WebSocket(`ws://${host}/rooms/${roomID}/enter/${userID}`);
        ws.onmessage = (event) => {
            dispatch(JSON.parse(event.data))
        }
    }

    const dispatch = ({eventType, eventData}) => {
        console.log(eventType, eventData)
        switch (eventType) {
            case "user_enter":
                userEnter(eventData)
                break;
            case "user_leave":
                userLeave(eventData)
                break;
            case "user_msg":
                userMsg(eventData)
                break;
        }
    }

    const userEnter = ({userID}) => {
        const divElement = document.createElement("div");
        divElement.innerText = userID + " enter the room";
        document.getElementById("msg").appendChild(divElement)
    }

    const userLeave = ({userID}) => {
        const divElement = document.createElement("div");
        divElement.innerText = userID + " leave the room";
        document.getElementById("msg").appendChild(divElement)
    }

    const userMsg = ({userID, message}) => {
        const divElement = document.createElement("div");
        divElement.innerText = userID + " send a message: " + message;
        document.getElementById("msg").appendChild(divElement)
    }
</script>
<script>
    let inputRoomID = "default"
    let inputUserID = "default"
    const onConnect = () => {
        const roomID = document.getElementById("room-id")
        const userID = document.getElementById("user-id")
        if (roomID.value && userID.value) {
            inputRoomID = roomID.value
            inputUserID = userID.value
            connect(roomID.value, inputUserID)
        } else {
            alert("please input room id")
        }
    }

    const onSend = () => {
        if (inputUserID === "default" || inputUserID === "default") {
            alert("please connect first")
            return
        }

        const msgInput = document.getElementById("msg-input")
        if (msgInput) {
            fetch(`http://${host}/rooms/${inputRoomID}/publish/${inputUserID}`, {
                method: "POST",
                body: JSON.stringify({
                    message: msgInput.value
                })
            })
        } else {
            alert("please input message")
        }
    }

    document.getElementById("msg-input").addEventListener("keydown", (event) => {
        if (event.code === "Enter") {
            onSend()
        }
    })
</script>
</body>
</html>